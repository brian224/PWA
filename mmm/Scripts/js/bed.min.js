var HEAVEN=HEAVEN||{};HEAVEN.canvas=function(){var e,t,n,a,s,i,o,c,r,d,l,u,h,g,m,p=document.getElementById("myCanvas"),f=(p.getContext("2d"),0),v={},w=64,b=w/4,y=64,x=y/4,j=$(".arrow-btn.left"),C=$(".arrow-btn.right"),T=$(".msk"),E=$(".list.type1"),M=$(".list.type2"),k=0,S=$("#myCanvas").offset(),B=parseInt(S.left,10),I=parseInt(S.top,10),_="",O=1,z=0,L=!1,R=function(e){Y(e.currentTarget)},X=function(e){var t=new Image;t.src=e,t.onload=R},Y=function(e){var n,a,s,i,o,c=e.width/2,r=e.height/2,n=new createjs.Container,d=new createjs.Matrix2D;d.scale(.5,.5),n.name="c"+f,n.w=c,n.h=r,n.x=300,n.y=50,n.dx=0,n.dy=0,n.dw=c,n.dh=r,n.range=Math.sqrt(Math.pow(c/2,2)+Math.pow(r/2,2)),n.scale=1,n.cursor="pointer",a=new createjs.Shape,a.graphics.drawRect(0,0,c,r),n.bg=a,n.addChild(a),a=new createjs.Shape,a.graphics.beginBitmapFill(e,"no-repeat",d).drawRect(0,0,c,r),n.source=a,n.addChild(a),s=new createjs.Shape,s.graphics.beginStroke("#fff").drawRect(-1,-1,c+2,r+2),s.set({visible:!1}),n.dash=s,n.addChild(s),i=new createjs.Shape,i.graphics.beginBitmapFill(v.remove).drawRect(0,0,w,w),"Mobile"===projects.device()?i.setTransform(2*-b,2*-b,1,1).set({y:r-2*b,visible:!1}):i.setTransform(-b,-b,.5,.5).set({y:r-b,visible:!1}),n.remove=i,n.addChild(i),o=new createjs.Shape,o.graphics.beginBitmapFill(v.resize).drawRect(0,0,y,y),"Mobile"===projects.device()?o.setTransform(2*-x,2*-x,1,1).set({x:c-2*x,visible:!1}):o.setTransform(-x,-x,.5,.5).set({x:c-x,visible:!1}),n.resize=o,n.addChild(o),t.addChild(n),f++,n.bg.on("mousedown",U,null,!1),n.source.on("mousedown",U,null,!1),n.remove.on("mousedown",K,null,!1),n.resize.on("mousedown",Q,null,!1),N(n.name)},N=function(e){var n,a=t.children,s=0,i=a.length;for(s=0;s<i;s++)a[s].name===e?(V(a[s]),n=a[s],c=n):D(a[s]);n&&t.addChild(n)},F=function(e,t,n,a,s,i){createjs.Tween.get(e.source).to({x:t,y:n,scaleX:i,scaleY:i},100,createjs.Ease.circOut()),createjs.Tween.get(e.dash).to({x:t,y:n,scaleX:i,scaleY:i},100,createjs.Ease.circOut()),"Mobile"===projects.device()?(createjs.Tween.get(e.remove).to({x:t-2*b,y:s-2*b},100,createjs.Ease.circOut()),createjs.Tween.get(e.resize).to({x:a-2*x,y:n-2*x},100,createjs.Ease.circOut())):(createjs.Tween.get(e.remove).to({x:t-b,y:s-b},100,createjs.Ease.circOut()),createjs.Tween.get(e.resize).to({x:a-x,y:n-x},100,createjs.Ease.circOut()))},A=function(e,t){e.dash.set({visible:t}),e.remove.set({visible:t}),e.resize.set({visible:t})},P=function(e){var t=1.02*e.scale,n=(1-t)*(e.w/2),a=(1-t)*(e.h/2);F(e,n,a,e.w-n,e.h-a,t)},q=function(e){F(e,e.dx,e.dy,e.dw,e.dh,e.scale)},H=function(e){var t=Math.min(Math.max(e/c.range,.2),2);c.scale=t,c.dx=(1-t)*(c.w/2),c.dy=(1-t)*(c.h/2),c.dw=c.dx+c.w*t,c.dh=c.dy+c.h*t,c.source.set({x:c.dx,y:c.dy,scaleX:t,scaleY:t}),c.dash.set({x:c.dx,y:c.dy,scaleX:t,scaleY:t}),c.remove.set({x:c.dx-b,y:c.dh-b}),c.resize.set({x:c.dw-b,y:c.dy-b})},V=function(e){A(e,!0)},D=function(e){A(e,!1)},K=function(e){t.removeChild(e.currentTarget.parent)},Q=function(e){he();var t=e.currentTarget.parent;a=t.w/2+t.x,s=t.h/2+t.y,$(document).on("mousemove touchmove",G).on("mouseup mouseleave touchend touchcancel",J)},G=function(e){var t=(e.pageX||e.originalEvent.touches[0].pageX)-B,n=(e.pageY||e.originalEvent.touches[0].pageY)-I,i=Math.sqrt(Math.pow(t-a,2)+Math.pow(n-s,2));H(i)},J=function(e){$(document).off("mousemove touchmove",G).off("mouseup mouseleave touchend touchcancel",J)},U=function(e){he();var t=e.currentTarget.parent;N(t.name),"bg"!==e.currentTarget.name&&"sheet"!==e.currentTarget.name&&(P(t),a=e.stageX,s=e.stageY,i=t.x,o=t.y,$(document).on("mousemove touchmove",W).on("mouseup mouseleave touchend touchcancel",Z))},W=function(e){var t=(e.pageX||e.originalEvent.touches[0].pageX)-B,n=(e.pageY||e.originalEvent.touches[0].pageY)-I,r=t-a,d=n-s;c.x=(i+r)/O,c.y=(o+d)/O,L&&(c.x+=10/O,c.y+=10/O)},Z=function(e){q(c),$(document).off("mousemove touchmove",W).off("mouseup mouseleave touchend touchcancel",Z)},ee=function(e){1==e?(n.getChildByName("s1").visible=!0,n.getChildByName("s2").visible=!1):(n.getChildByName("s1").visible=!1,n.getChildByName("s2").visible=!0)},te=function(){var t;n=new createjs.Container,n.set({x:180,y:129}),n.name="sheet",t=new createjs.Shape,t.graphics.beginBitmapFill(v.s1).drawRect(0,0,v.s1.width,v.s1.height),t.visible=!1,t.name="s1",n.addChild(t),t=new createjs.Shape,t.graphics.beginBitmapFill(v.s2).drawRect(0,0,v.s2.width,v.s2.height),t.visible=!1,t.name="s2",n.addChild(t),e.addChild(n)},ne=function(){e=new createjs.Stage("myCanvas"),e.enableMouseOver(),createjs.Touch.enable(e);var n=new createjs.Shape;n.graphics.beginBitmapFill(v.bg).drawRect(0,0,v.bg.width,v.bg.height),n.name="bg",e.addChild(n),t=new createjs.Container,t.set({x:0,y:0}),e.addChild(t),te(),ee($("input[name*=sheet]:checked").val()),n.on("mousedown",U,null,!1),createjs.Ticker.setFPS(60),createjs.Ticker.addEventListener("tick",ae),$(".obj").on("click",function(e){X($(this).children("img").attr("src"))}),$("input[name*=sheet]").on("click",function(e){ee($("input[name*=sheet]:checked").val())})},ae=function(){e.update()},se=function(e){"image"==e.item.type&&(v[e.item.id]=e.result)},ie=function(){ne()},oe=function(){var e,t=[{src:"bed_bg.jpg",id:"bg"},{src:"share_bg_01.png",id:"sbg1"},{src:"share_bg_02.png",id:"sbg2"},{src:"share_sign_01.png",id:"ss1"},{src:"bed_b_01.png",id:"s1"},{src:"bed_b_02.png",id:"s2"},{src:"resize.png",id:"resize"},{src:"remove.png",id:"remove"}];e=new createjs.LoadQueue((!1)),e.addEventListener("fileload",se),e.addEventListener("complete",ie),e.loadManifest(t,!0,"../../Content/img/bed/")},ce=function(e){var t=$("<canvas>")[0],n=t.getContext("2d");N("bg"),t.width=1200,t.height=630,n.font="bold 40px 微軟正黑體",$("#bd2").prop("checked")?n.drawImage(v.sbg2,0,0,1200,630):n.drawImage(v.sbg1,0,0,1200,630),re(n,_),setTimeout(function(){n.drawImage(p,25,25,580,580),n.drawImage(v.ss1,588,406,185,133),pe(t.toDataURL("image/png",1))},100)},re=function(e,t){var n,a,s=(t.length+10-1)/10;for(n=0;n<s;n++)a=10*n,e.fillText(t.slice(a,a+10),734,231+50*n)},de=function(e){1==e?(E.show().css("marginLeft",0),M.hide().css("marginLeft",0),g=-u,m=E):(E.hide().css("marginLeft",0),M.show().css("marginLeft",0),g=-h,m=M),k=0,ue()},le=function(e){"left"==e?k++:k--,k=Math.min(Math.max(k,g),0),m.stop().animate({marginLeft:k*r},250,function(){ue()})},ue=function(){0==k?j.css("opacity",0):j.css("opacity",1),k==g?C.css("opacity",0):C.css("opacity",1)},he=function(){S=$("#myCanvas").offset(),B=parseInt(S.left,10),I=parseInt(S.top,10)},ge=function(){var e=E.children("a"),t=M.children("a"),n=Math.round(e.width()+parseInt(e.css("margin-right"),10)),a=$(window).width()/640;r=T.width(),L&&(r=440*a,n=110*a,O=540*a/600,z=600/(540*a)),d=n*e.length,l=n*t.length,u=Math.floor((e.length+4-1)/4)-1,h=Math.floor((t.length+4-1)/4)-1,he()},me=function(){$(".get-btn").addClass("is-loading"),$.ajax({type:"GET",url:$(".get-btn").data("url"),dataType:"json",success:function(e){_=e.reason},error:function(e,t,n){console.log(e.responseText+","+e.status+","+e.readyState+","+e.statusText)},complete:function(e){$(".get-btn").delay(1200).queue(function(){$(".txt-sub").text(_),$(this).removeClass("is-loading").dequeue()})}})},pe=function(e){$.ajax({type:"POST",url:$(".ok-btn").data("url"),data:{image:e.split("data:image/png;base64,")[1],title:_},dataType:"json",success:function(e){},error:function(e,t,n){console.log(e.responseText+","+e.status+","+e.readyState+","+e.statusText)},complete:function(e){window.location.href=e.responseJSON.url}})},fe=function(){L=!!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),ge(),$(window).resize(ge),oe(),de($("input[name*=type]:checked").val()),$("input[name*=type]").on("click",function(e){de($("input[name*=type]:checked").val())}),$(".arrow-btn").on("click",function(e){le($(this).data("arrow"))}),$(".get-btn").on("click",me),me(),$(".ok-btn").on("click",ce)};return fe(),{init:fe}}(),projects.$d.ready(function(){"true"!==localStorage.getItem("alreadyKnown")&&$(common._lBody).addClass("show-lightbox"),$(".jQ-hint").on("click",function(){$(common._lBody).removeClass("show-lightbox"),localStorage.setItem("alreadyKnown","true")})});